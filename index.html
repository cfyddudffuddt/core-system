<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORE IMPERIUM | The Constructor</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* --- 1. CORE THEME --- */
        :root {
            --bg: #020204;
            --gold: #FFD700; 
            --cyan: #00f3ff;
            --danger: #ff003c;
            --glass: rgba(10, 15, 20, 0.95);
            --border-glow: 0 0 15px rgba(0, 243, 255, 0.2);
        }
        * { box-sizing: border-box; user-select: none; }
        body { 
            margin: 0; font-family: 'Share Tech Mono', monospace; 
            background: var(--bg); color: #e0e0e0; overflow-x: hidden; cursor: crosshair;
        }

        /* --- 2. BACKGROUND LAYERS --- */
        .humanoid-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://images.unsplash.com/photo-1531746790731-6c087fecd65a?q=80&w=2606&auto=format&fit=crop') no-repeat center center/cover;
            opacity: 0.15; z-index: -3; filter: contrast(120%) saturate(0%);
        }
        .vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 40%, #000 90%); z-index: -2; pointer-events: none; }
        canvas#bg-canvas { position: fixed; top: 0; left: 0; z-index: -1; }
        
        /* HUD Lines */
        .hud-line { position: fixed; background: rgba(0, 243, 255, 0.1); z-index: -1; pointer-events: none; }
        .hl-top { top: 100px; left: 5%; width: 90%; height: 1px; }
        .hl-bot { bottom: 100px; left: 5%; width: 90%; height: 1px; }

        /* --- 3. NAVIGATION --- */
        nav {
            display: flex; justify-content: space-between; align-items: center; padding: 20px 40px;
            position: fixed; width: 100%; top: 0; z-index: 1000;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }
        .guild-mark { 
            font-family: 'Cinzel', serif; font-weight: 900; font-size: 24px; 
            letter-spacing: 3px; color: white; text-shadow: 0 0 10px var(--cyan);
            border-left: 4px solid var(--gold); padding-left: 15px; cursor: pointer;
        }
        .nav-menu { display: flex; gap: 15px; align-items: center; }

        /* --- 4. BUTTONS --- */
        .btn { 
            padding: 8px 20px; background: rgba(0, 20, 40, 0.6); 
            border: 1px solid var(--cyan); color: var(--cyan);
            font-family: 'Share Tech Mono', monospace; font-weight: 700; cursor: pointer; transition: 0.2s; 
            font-size: 12px; letter-spacing: 2px; text-transform: uppercase;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .btn:hover { background: var(--cyan); color: black; box-shadow: 0 0 20px var(--cyan); transform: scale(1.05); }
        .btn-gold { border-color: var(--gold); color: var(--gold); }
        .btn-gold:hover { background: var(--gold); box-shadow: 0 0 20px var(--gold); }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); box-shadow: 0 0 20px var(--danger); }
        .hidden { display: none !important; }

        /* --- 5. HERO --- */
        .hero { 
            height: 90vh; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center; 
            position: relative; z-index: 10;
        }
        .core-eye-socket { 
            width: 120px; height: 120px; border-radius: 50%; border: 2px solid var(--gold); 
            display: flex; justify-content: center; align-items: center; 
            margin-bottom: 30px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.1); 
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        }
        .core-pupil { 
            width: 40px; height: 40px; background: var(--gold); border-radius: 50%; 
            box-shadow: 0 0 30px var(--gold); transition: transform 0.05s; 
        }
        h1 { 
            font-family: 'Cinzel', serif; font-size: 60px; margin: 0; line-height: 1.1; 
            color: white; letter-spacing: 5px; text-shadow: 0 0 20px rgba(0, 243, 255, 0.5); 
        }
        .status-text { color: var(--cyan); font-size: 14px; margin-top: 10px; letter-spacing: 2px; text-transform: uppercase; }

        /* --- 6. DOMAINS --- */
        .domain-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; max-width: 1200px; margin: 0 auto 50px auto; padding: 0 20px; position: relative; z-index: 10;
        }
        .domain-card { 
            background: linear-gradient(135deg, rgba(20,20,25,0.9) 0%, rgba(10,10,15,0.95) 100%);
            padding: 30px; text-align: center; border: 1px solid #333; border-top: 2px solid var(--cyan);
            transition: 0.3s; cursor: pointer; position: relative;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        .domain-card:hover { transform: translateY(-5px); border-color: var(--gold); box-shadow: 0 0 30px rgba(0, 243, 255, 0.1); }
        .d-icon { font-size: 40px; color: #555; margin-bottom: 15px; display: block; }
        .domain-card:hover .d-icon { color: var(--gold); text-shadow: 0 0 10px var(--gold); }
        .domain-card h3 { font-family: 'Cinzel'; color: white; margin: 0; }

        /* --- 7. MODALS --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); 
            display: flex; justify-content: center; align-items: center; z-index: 2000; 
        }
        .scroll-box { 
            background: #0a0a0f; border: 1px solid var(--cyan); padding: 40px; 
            width: 90%; max-width: 1000px; text-align: center; position: relative; 
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.15); 
            clip-path: polygon(30px 0, 100% 0, 100% calc(100% - 30px), calc(100% - 30px) 100%, 0 100%, 0 30px); 
        }
        .royal-input { width: 100%; padding: 15px; margin-bottom: 15px; background: #111; border: 1px solid #333; color: var(--cyan); text-align: center; font-family: 'Share Tech Mono'; font-size: 18px; outline:none; }
        
        /* --- 8. HOLODECK (CONSTRUCTOR) --- */
        #holo-viewport {
            width: 100%; height: 500px; background: radial-gradient(circle, #1a1a20 0%, #000 100%);
            border: 1px solid #333; margin-bottom: 20px; position: relative; overflow: hidden;
        }
        /* Blueprint Grid Lines */
        #holo-viewport::after {
            content: ""; position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px; pointer-events: none;
        }
        
        .holo-sidebar {
            position: absolute; top: 0; left: 0; width: 200px; height: 100%;
            background: rgba(0,0,0,0.8); border-right: 1px solid var(--cyan);
            padding: 20px; display: flex; flex-direction: column; gap: 10px;
        }
        .part-btn {
            background: #111; border: 1px solid #333; color: #aaa; padding: 10px;
            cursor: pointer; text-align: left; font-size: 11px; transition: 0.2s;
            display: flex; align-items: center; gap: 10px;
        }
        .part-btn:hover { border-color: var(--cyan); color: white; background: rgba(0, 243, 255, 0.1); }
        .part-icon { font-size: 16px; }

        .holo-controls {
            position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px;
        }

        /* --- 9. SYNDICATE BOARD --- */
        .board-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; height: 350px; text-align: left; }
        .board-col { background: rgba(0,0,0,0.5); border: 1px solid #333; padding: 10px; overflow-y: auto; }
        .col-title { color: var(--gold); border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 10px; font-family: 'Cinzel'; text-align: center; }
        .task-card { background: #15151a; border: 1px solid var(--cyan); padding: 10px; margin-bottom: 8px; font-size: 12px; cursor: grab; }
        .task-card:active { cursor: grabbing; }

        /* --- 10. UTILS --- */
        #map-container { width: 100%; height: 400px; background: #050508; position: relative; border: 1px solid #333; }
        .map-hud { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid var(--gold); pointer-events: none; }
        .chat-drawer { position: fixed; top: 0; right: -400px; width: 350px; height: 100%; background: #050508; border-left: 2px solid var(--cyan); transition: 0.3s; z-index: 2500; display: flex; flex-direction: column; }
        .chat-drawer.open { right: 0; }
        #audio-toggle { position: fixed; bottom: 20px; left: 20px; color: #555; cursor: pointer; z-index: 3000; font-size: 10px; }
        #audio-toggle.active { color: var(--cyan); }
    </style>
</head>
<body>

    <div id="boot-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: var(--cyan);">
        <div style="margin-bottom: 10px;">INITIALIZING CORE KERNEL...</div>
        <div id="boot-btn" style="display:none; margin-top:20px; border:1px solid var(--cyan); padding:15px 30px; cursor:pointer; background:rgba(0, 243, 255, 0.1);" onclick="enterSite()">[ ENTER IMPERIUM ]</div>
    </div>

    <div id="audio-toggle" onclick="toggleAudio()">AUDIO: OFF</div>
    <div class="humanoid-bg"></div>
    <div class="vignette"></div>
    <div class="hud-line hl-top"></div>
    <div class="hud-line hl-bot"></div>
    <canvas id="bg-canvas"></canvas>

    <nav>
        <div class="guild-mark" onclick="cheatCode()">CORE // IMPERIUM</div>
        <div class="nav-menu">
            <div id="shard-wallet" style="color:var(--cyan); font-weight:bold; display:none">üíé 0</div>
            <button class="btn hidden" id="holodeck-btn" onmouseenter="playHover()" onclick="openRoomModal()">HOLODECK</button>
            <button class="btn hidden" id="syndicate-btn" onmouseenter="playHover()" onclick="openSyndicate()">SYNDICATE</button>
            <button class="btn hidden" id="map-btn" onmouseenter="playHover()" onclick="openMap()">WAR ROOM</button>
            <button class="btn hidden" id="chat-btn" onmouseenter="playHover()" onclick="toggleChat()">COMMS</button>
            <button class="btn hidden" id="id-card-btn" onmouseenter="playHover()" onclick="openIDCard()">ID</button>
            <button class="btn btn-gold" id="auth-btn" onmouseenter="playHover()" onclick="openModal('login')">INITIALIZE</button>
        </div>
    </nav>

    <div class="hero">
        <div class="core-eye-socket"><div class="core-pupil" id="eye-pupil"></div></div>
        <div class="status-text">SENTIENT INTERFACE ONLINE</div>
        <h1>DOMINION OF STEEL<br><span style="color:var(--gold)">SOUL OF CODE</span></h1>
        
        <div style="margin-top:30px; display:flex; gap:15px;">
            <button class="btn btn-gold" style="padding: 15px 40px; font-size: 16px;" onmouseenter="playHover()" onclick="scrollToArena()">ACCESS TERMINAL</button>
            <button class="btn btn-danger hidden" id="breach-btn" style="padding: 15px 40px; font-size: 16px;" onmouseenter="playHover()" onclick="startBreach()">[ BREACH ]</button>
        </div>
    </div>

    <div class="domain-grid">
        <div class="domain-card" onmouseenter="playHover()" onclick="openRoomModal()">
            <div class="d-icon">üìê</div><h3>3D FORGE</h3><p style="color:#888; font-size:12px">CONSTRUCT MECHS</p>
        </div>
        <div class="domain-card" onmouseenter="playHover()" onclick="openSyndicate()">
            <div class="d-icon">üõ°Ô∏è</div><h3>SYNDICATE</h3><p style="color:#888; font-size:12px">FACTION MANAGEMENT</p>
        </div>
        <div class="domain-card" onmouseenter="playHover()" onclick="openMap()">
            <div class="d-icon">üåç</div><h3>GLOBAL GRID</h3><p style="color:#888; font-size:12px">TERRITORY CONTROL</p>
        </div>
    </div>

    <div id="arena" style="max-width: 900px; margin: 0 auto 100px auto; padding: 2px; background: linear-gradient(90deg, transparent, var(--gold), transparent);">
        <div style="background: #050508; padding: 40px; text-align: center;">
            <h2 style="font-family: 'Cinzel'; color:var(--gold); margin-top:0">PROVING GROUNDS</h2>
            <div id="chat-display" style="height: 150px; overflow-y: auto; border: 1px solid #333; padding: 20px; margin-bottom: 20px; font-family: 'Share Tech Mono'; background: rgba(0,0,0,0.5); text-align: left;">
                <div style="color:var(--gold)">[SYSTEM]: UPLINK ESTABLISHED. WAITING FOR INPUT.</div>
            </div>
            <div style="display:flex; gap:10px">
                <button class="btn" style="flex:1" onmouseenter="playHover()" onclick="startTrial()">‚öîÔ∏è START TRIAL</button>
                <button class="btn" style="flex:1" id="mic-btn" onmouseenter="playHover()" onclick="toggleMic()">üé§ VOICE INPUT</button>
            </div>
        </div>
    </div>

    <div id="holodeck-modal" class="modal-overlay hidden">
        <div class="scroll-box" style="width: 1100px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="color:var(--gold); margin:0">MECH ASSEMBLER V1</h2>
                <div style="color:var(--cyan)" id="room-display">OFFLINE</div>
            </div>
            
            <div id="holo-viewport">
                <div class="holo-sidebar">
                    <div style="color:white; font-size:12px; margin-bottom:10px; border-bottom:1px solid #444; padding-bottom:5px">COMPONENTS</div>
                    <button class="part-btn" onclick="addPart('core')"><span class="part-icon">üí†</span> CORE REACTOR</button>
                    <button class="part-btn" onclick="addPart('chassis')"><span class="part-icon">üõ°Ô∏è</span> ARMOR CHASSIS</button>
                    <button class="part-btn" onclick="addPart('thruster')"><span class="part-icon">üöÄ</span> ION THRUSTER</button>
                    <button class="part-btn" onclick="addPart('sensor')"><span class="part-icon">üì°</span> SENSOR ARRAY</button>
                    <button class="part-btn" onclick="addPart('joint')"><span class="part-icon">‚öôÔ∏è</span> HYDRAULIC JOINT</button>
                </div>
                
                <div class="holo-controls">
                    <button class="btn btn-gold" onclick="saveBlueprint()">SAVE BLUEPRINT</button>
                    <button class="btn btn-danger" onclick="clearScene()">CLEAR ALL</button>
                </div>
            </div>
            
            <button class="btn" onclick="exitHolodeck()">EXIT WORKSHOP</button>
        </div>
    </div>

    <div id="room-modal" class="modal-overlay hidden">
        <div class="scroll-box">
            <h2 style="color:var(--gold)">PROJECT INITIALIZATION</h2>
            <p style="color:#888; font-size:12px">ENTER PROJECT ID TO JOIN SESSION</p>
            <input type="text" id="room-id-input" class="royal-input" placeholder="PROJECT NAME">
            <button class="btn btn-gold" style="width:100%" onclick="enterHolodeck()">INITIALIZE</button>
            <br><br><button class="btn" onclick="closeModals()">CANCEL</button>
        </div>
    </div>

    <div id="syndicate-modal" class="modal-overlay hidden">
        <div class="scroll-box" style="width: 900px;">
            <div id="no-syndicate-view">
                <h2 style="color:var(--gold)">SYNDICATE REGISTRY</h2>
                <div style="display:flex; gap:20px; margin-top:30px;">
                    <div style="flex:1; border:1px solid #333; padding:20px;">
                        <h3 style="margin-top:0; color:white">CREATE</h3>
                        <input type="text" id="create-syn-name" class="royal-input" placeholder="NAME">
                        <button class="btn btn-gold" style="width:100%" onclick="createSyndicate()">FORGE (500üíé)</button>
                    </div>
                    <div style="flex:1; border:1px solid #333; padding:20px;">
                        <h3 style="margin-top:0; color:white">JOIN</h3>
                        <input type="text" id="join-syn-name" class="royal-input" placeholder="NAME">
                        <button class="btn" style="width:100%" onclick="joinSyndicate()">JOIN</button>
                    </div>
                </div>
                <br><button class="btn" onclick="closeModals()">CLOSE</button>
            </div>
            <div id="active-syndicate-view" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px;">
                    <h2 style="color:var(--gold); margin:0" id="syn-title">IRON LEGION</h2>
                    <div style="color:var(--cyan)" id="syn-treasury">VAULT: 0 üíé</div>
                </div>
                <div class="board-container" style="margin-top:20px;">
                    <div class="board-col" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)"><div class="col-title">PENDING</div><div id="col-todo"></div><button class="btn" style="width:100%; margin-top:10px; font-size:10px" onclick="addTask()">+ INTEL</button></div>
                    <div class="board-col" ondrop="drop(event, 'prog')" ondragover="allowDrop(event)"><div class="col-title">ACTIVE</div><div id="col-prog"></div></div>
                    <div class="board-col" ondrop="drop(event, 'done')" ondragover="allowDrop(event)"><div class="col-title">SECURED</div><div id="col-done"></div></div>
                </div>
                <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;"><button class="btn btn-gold" onclick="donateShards()">DONATE 100üíé</button><button class="btn btn-danger" onclick="leaveSyndicate()">LEAVE</button><button class="btn" onclick="closeModals()">CLOSE</button></div>
            </div>
        </div>
    </div>

    <div id="map-modal" class="modal-overlay hidden">
        <div class="scroll-box" style="width: 800px; padding:0; overflow:hidden; border:2px solid var(--gold);">
            <div id="map-container">
                <canvas id="sector-canvas" style="width:100%; height:100%"></canvas>
                <div class="map-hud"><div style="color:var(--gold); font-weight:bold">GLOBAL GRID</div><div style="color:#aaa; font-size:10px">SECTORS: <span id="map-control-count" style="color:white">0</span></div></div>
            </div>
            <div style="padding:10px; background:#111; border-top:1px solid #333;"><button class="btn btn-danger" onclick="closeModals()">DISCONNECT</button></div>
        </div>
    </div>

    <div id="login-modal" class="modal-overlay hidden"><div class="scroll-box"><h2 style="color:var(--gold)">ACCESS</h2><input type="email" id="l-email" class="royal-input" placeholder="EMAIL"><input type="password" id="l-pass" class="royal-input" placeholder="CODE"><button class="btn btn-gold" style="width:100%" onclick="handleLogin()">LOGIN</button><p onclick="switchModal('login','register')" style="color:#888; cursor:pointer; font-size:12px; margin-top:15px">>> REGISTER</p><br><button class="btn" onclick="closeModals()">CANCEL</button></div></div>
    <div id="register-modal" class="modal-overlay hidden"><div class="scroll-box"><h2 style="color:var(--gold)">NEW UNIT</h2><input type="email" id="r-email" class="royal-input" placeholder="EMAIL"><input type="password" id="r-pass" class="royal-input" placeholder="CODE"><button class="btn btn-gold" style="width:100%" onclick="handleRegister()">REGISTER</button><p onclick="switchModal('register','login')" style="color:#888; cursor:pointer; font-size:12px; margin-top:15px">[ BACK ]</p><br><button class="btn" onclick="closeModals()">CANCEL</button></div></div>
    <div id="id-modal" class="modal-overlay hidden"><div class="scroll-box"><div style="width:100%; height:200px; background:#111; border:2px solid var(--gold); border-radius:10px; display:flex; padding:20px; justify-content:space-between; align-items:center;" id="tilt-card"><div style="text-align:left"><div id="id-avatar" style="font-size:50px">ü§ñ</div><div style="color:var(--gold);font-weight:bold" id="id-email">UNIT</div></div><div style="text-align:right"><div id="qrcode" style="background:white; padding:5px"></div><div id="id-rank" style="color:var(--gold);margin-top:10px;font-weight:bold">INITIATE</div></div></div><br><button class="btn" onclick="closeModals()">CLOSE</button></div></div>
    <div id="chat-drawer" class="chat-drawer"><div style="padding:20px; border-bottom:1px solid var(--cyan); display:flex; justify-content:space-between"><span style="color:var(--cyan)">COMMS</span><span style="cursor:pointer" onclick="toggleChat()">X</span></div><div style="flex:1; overflow-y:auto; padding:20px; gap:15px; display:flex; flex-direction:column" id="global-chat-feed"></div><div style="padding:20px; background:#000"><input type="text" id="chat-msg-input" style="width:100%; padding:10px; background:#111; border:1px solid #333; color:var(--cyan)" placeholder="Transmit..."><button class="btn" style="width:100%; margin-top:5px" onclick="sendGlobalMessage()">SEND</button></div></div>
    <div id="breach-modal" class="modal-overlay hidden"><div class="scroll-box" style="border-color:var(--danger)"><h2 style="color:var(--danger)">BREACH</h2><div style="text-align:center; margin-bottom:10px">LOCKS: <span id="breach-locks">0/3</span></div><div style="width:100%; height:30px; background:#111; position:relative; overflow:hidden; border:1px solid #333; margin-bottom:20px"><div style="position:absolute; top:0; left:40%; width:20%; height:100%; background:rgba(0,243,255,0.3); border-left:2px solid var(--cyan); border-right:2px solid var(--cyan)"></div><div id="b-cursor" style="position:absolute; top:0; left:0; width:5px; height:100%; background:var(--danger); box-shadow:0 0 10px var(--danger)"></div></div><button class="btn btn-danger" style="width:100%" onmousedown="attemptHack()">[ LOCK ]</button></div></div>

    <script>
        setTimeout(() => { document.getElementById('boot-btn').style.display='block'; }, 1000);
        function enterSite() { document.getElementById('boot-screen').style.display='none'; if(window.toggleAudio) window.toggleAudio(); }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/jsm/controls/TransformControls.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, query, orderBy, limit, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyCix4eALWZyYsQU7lPuZMSRfnBNDW4AKK0", authDomain: "core-system-d53c1.firebaseapp.com", projectId: "core-system-d53c1", storageBucket: "core-system-d53c1.firebasestorage.app", messagingSenderId: "854751335854", appId: "1:854751335854:web:791657757cfa112c1ae43f" };
        const systemKey = "AIzaSyAUegF_e6r4ZoSJveUmzsnORM4NNP-RtqI"; 
        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error("Offline"); }
        let currentUser = null; let userData = { rank: "INITIATE", avatar: "ü§ñ", shards: 0, syndicate: null };

        // --- HOLODECK: THE CONSTRUCTOR ---
        let hdScene, hdCamera, hdRenderer, hdControls, hdTransform;
        let hdObjects = {}; let currentRoomId = null; let hdUnsub = null;

        window.openRoomModal = () => { playClick(); document.getElementById('room-modal').classList.remove('hidden'); }
        window.enterHolodeck = () => {
            const room = document.getElementById('room-id-input').value.toUpperCase();
            if(!room) return;
            currentRoomId = room;
            closeModals();
            document.getElementById('holodeck-modal').classList.remove('hidden');
            document.getElementById('room-display').innerText = `PROJECT: ${room}`;
            setTimeout(initHolodeck, 100);
        }
        window.exitHolodeck = () => { closeModals(); if(hdUnsub) hdUnsub(); document.getElementById('holo-viewport').innerHTML = ''; hdScene = null; }
        
        // ADD ROBOT PARTS
        window.addPart = async (type) => {
            if(!currentRoomId) return;
            playClick();
            if(db) await addDoc(collection(db, "rooms", currentRoomId, "objects"), { type: type, x:0, y:0, z:0 });
            else createMesh('temp'+Math.random(), {type:type, x:0, y:0, z:0});
        }
        
        window.saveBlueprint = () => { alert("BLUEPRINT SAVED TO SYNDICATE VAULT."); }
        window.clearScene = () => { alert("CLEARING WORKSPACE..."); }

        function initHolodeck() {
            const container = document.getElementById('holo-viewport');
            hdScene = new THREE.Scene();
            hdScene.background = new THREE.Color(0x111116);
            hdScene.add(new THREE.GridHelper(20, 20, 0x00f3ff, 0x333333));
            const light = new THREE.DirectionalLight(0xffffff, 1); light.position.set(5, 10, 7); hdScene.add(light);
            hdScene.add(new THREE.AmbientLight(0x404040));
            hdCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            hdCamera.position.set(5, 5, 5);
            hdRenderer = new THREE.WebGLRenderer({ antialias: true });
            hdRenderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(hdRenderer.domElement);
            hdControls = new THREE.OrbitControls(hdCamera, hdRenderer.domElement);
            hdTransform = new THREE.TransformControls(hdCamera, hdRenderer.domElement);
            hdTransform.addEventListener('dragging-changed', (e) => { hdControls.enabled = !e.value; });
            hdTransform.addEventListener('change', () => { if(hdTransform.object) updateObjectInDB(hdTransform.object.userData.id, hdTransform.object.position); });
            hdScene.add(hdTransform);
            
            const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();
            hdRenderer.domElement.addEventListener('pointerdown', (e) => {
                const rect = hdRenderer.domElement.getBoundingClientRect();
                mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                raycaster.setFromCamera(mouse, hdCamera);
                const intersects = raycaster.intersectObjects(Object.values(hdObjects));
                if(intersects.length > 0) hdTransform.attach(intersects[0].object); else hdTransform.detach();
            });
            const animate = () => { if(!hdScene) return; requestAnimationFrame(animate); hdRenderer.render(hdScene, hdCamera); }; animate();
            if(db) startRoomSync();
        }

        function startRoomSync() {
            hdObjects = {};
            const q = collection(db, "rooms", currentRoomId, "objects");
            hdUnsub = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data(); const id = change.doc.id;
                    if(change.type === "added") createMesh(id, data);
                    if(change.type === "modified") { if(hdObjects[id] && hdTransform.object !== hdObjects[id]) { hdObjects[id].position.set(data.x, data.y, data.z); } }
                });
            });
        }

        function createMesh(id, data) {
            let geo, mat = new THREE.MeshLambertMaterial({ color: 0x00f3ff, wireframe: false });
            // COMPLEX PARTS
            if(data.type === 'core') geo = new THREE.IcosahedronGeometry(1, 0); 
            else if(data.type === 'chassis') geo = new THREE.BoxGeometry(2, 1, 3);
            else if(data.type === 'thruster') geo = new THREE.ConeGeometry(0.5, 2, 16);
            else if(data.type === 'sensor') geo = new THREE.SphereGeometry(0.5, 16, 16);
            else geo = new THREE.CylinderGeometry(0.2, 0.2, 2, 8); // joint
            
            if(data.type === 'chassis') mat = new THREE.MeshLambertMaterial({ color: 0x333333 });
            if(data.type === 'core') mat = new THREE.MeshLambertMaterial({ color: 0xffd700, wireframe: true });

            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(data.x, data.y, data.z);
            mesh.userData.id = id;
            hdScene.add(mesh);
            hdObjects[id] = mesh;
        }
        async function updateObjectInDB(id, pos) { if(db) await updateDoc(doc(db, "rooms", currentRoomId, "objects", id), { x: pos.x, y: pos.y, z: pos.z }); }

        // --- MAP, SYNDICATE, UTILS ---
        // (Retaining core functionality for stability)
        let audioCtx,audioEnabled=false; window.toggleAudio=()=>{if(!audioEnabled){audioCtx=new(window.AudioContext||window.webkitAudioContext)();audioEnabled=true;document.getElementById('audio-toggle').innerText="AUDIO: ON";playBootSound();}else{audioEnabled=false;document.getElementById('audio-toggle').innerText="AUDIO: OFF";}}
        window.playHover=()=>{if(!audioEnabled)return;const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type="sine";o.frequency.setValueAtTime(400,audioCtx.currentTime);g.gain.setValueAtTime(0.05,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.1);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.1);}
        window.playClick=()=>{if(!audioEnabled)return;const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type="square";o.frequency.setValueAtTime(100,audioCtx.currentTime);g.gain.setValueAtTime(0.1,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.1);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.1);}
        function playBootSound(){const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type="sawtooth";o.frequency.setValueAtTime(50,audioCtx.currentTime);g.gain.setValueAtTime(0.1,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+2);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+2);}
        
        window.openModal=(id)=>{playClick();document.getElementById(id+'-modal').classList.remove('hidden');}
        window.closeModals=()=>{playClick();document.querySelectorAll('.modal-overlay').forEach(e=>e.classList.add('hidden'));}
        window.switchModal=(f,t)=>{playClick();document.getElementById(f+'-modal').classList.add('hidden');document.getElementById(t+'-modal').classList.remove('hidden');}
        window.handleLogin=async()=>{playClick();try{await signInWithEmailAndPassword(auth,document.getElementById('l-email').value,document.getElementById('l-pass').value);closeModals();}catch(e){alert(e.message);}}
        window.handleRegister=async()=>{playClick();try{await createUserWithEmailAndPassword(auth,document.getElementById('r-email').value,document.getElementById('r-pass').value);closeModals();}catch(e){alert(e.message);}}
        window.toggleChat=()=>document.getElementById('chat-drawer').classList.toggle('open');
        window.sendGlobalMessage=async()=>{const t=document.getElementById('chat-msg-input').value;if(!t||!currentUser)return;playClick();await addDoc(collection(db,"council_chat"),{text:t,user:currentUser.email.split('@')[0],rank:userData.rank,avatar:userData.avatar,timestamp:serverTimestamp()});document.getElementById('chat-msg-input').value="";}
        if(db) onSnapshot(query(collection(db,"council_chat"),orderBy("timestamp","asc"),limit(50)),(s)=>{const f=document.getElementById('global-chat-feed');f.innerHTML="";s.forEach(d=>{const v=d.data();f.innerHTML+=`<div style="display:flex;gap:10px;margin-bottom:10px;font-size:13px"><div style="color:var(--gold)">${v.avatar||"ü§ñ"}</div><div><span style="color:var(--cyan)">${v.rank}</span> <span style="color:#888">${v.user}</span><div>${v.text}</div></div></div>`;});f.scrollTop=f.scrollHeight;});
        
        // BREACH
        let breachActive=false, breachPos=0, breachDir=1, breachLocks=0, breachAnim;
        window.startBreach=()=>{playClick();document.getElementById('breach-modal').classList.remove('hidden');breachActive=true;breachLocks=0;document.getElementById('breach-locks').innerText="0/3";requestAnimationFrame(breachLoop);}
        function breachLoop(){if(!breachActive)return;const c=document.getElementById('b-cursor');breachPos+=2*breachDir;if(breachPos>98||breachPos<0)breachDir*=-1;c.style.left=breachPos+"%";breachAnim=requestAnimationFrame(breachLoop);}
        window.attemptHack=async()=>{if(breachPos>=40&&breachPos<=60){breachLocks++;document.getElementById('breach-locks').innerText=breachLocks+"/3";playClick();if(breachLocks>=3){breachActive=false;cancelAnimationFrame(breachAnim);document.getElementById('breach-modal').classList.add('hidden');alert("SUCCESS.");if(currentUser)await updateDoc(doc(db,"users",currentUser.uid),{shards:increment(500)});}}else{breachLocks=0;document.getElementById('breach-locks').innerText="FAILED";}}

        // MAP
        let mapCanvas, mapCtx, sectors={};
        window.openMap=()=>{playClick();document.getElementById('map-modal').classList.remove('hidden');mapCanvas=document.getElementById('sector-canvas');mapCtx=mapCanvas.getContext('2d');const c=document.getElementById('map-container');mapCanvas.width=c.clientWidth;mapCanvas.height=c.clientHeight;drawMap();}
        function drawMap(){mapCtx.fillStyle="#000";mapCtx.fillRect(0,0,mapCanvas.width,mapCanvas.height);for(let x=0;x<mapCanvas.width;x+=30){for(let y=0;y<mapCanvas.height;y+=30){mapCtx.strokeStyle="#222";mapCtx.strokeRect(x,y,30,30);}}}
        window.closeMap=()=>{document.getElementById('map-modal').classList.add('hidden');}

        // SYNDICATE
        let syndicateUnsub=null;
        window.openSyndicate=()=>{playClick();document.getElementById('syndicate-modal').classList.remove('hidden');if(userData.syndicate){document.getElementById('no-syndicate-view').classList.add('hidden');document.getElementById('active-syndicate-view').classList.remove('hidden');loadSyndicate(userData.syndicate);}else{document.getElementById('no-syndicate-view').classList.remove('hidden');document.getElementById('active-syndicate-view').classList.add('hidden');}}
        window.createSyndicate=async()=>{const n=document.getElementById('create-syn-name').value.toUpperCase();if(!n||userData.shards<500){alert("ERROR");return;}await setDoc(doc(db,"syndicates",n),{treasury:0,members:[currentUser.uid]});await updateDoc(doc(db,"users",currentUser.uid),{syndicate:n,shards:increment(-500)});openSyndicate();}
        window.joinSyndicate=async()=>{const n=document.getElementById('join-syn-name').value.toUpperCase();if(!n)return;const r=doc(db,"syndicates",n);const s=await getDoc(r);if(s.exists()){await updateDoc(r,{members:[...s.data().members,currentUser.uid]});await updateDoc(doc(db,"users",currentUser.uid),{syndicate:n});openSyndicate();}else{alert("NOT FOUND");}}
        window.leaveSyndicate=async()=>{if(!confirm("LEAVE?"))return;await updateDoc(doc(db,"users",currentUser.uid),{syndicate:null});openSyndicate();}
        window.donateShards=async()=>{if(userData.shards<100)return;await updateDoc(doc(db,"users",currentUser.uid),{shards:increment(-100)});await updateDoc(doc(db,"syndicates",userData.syndicate),{treasury:increment(100)});}
        function loadSyndicate(n){document.getElementById('syn-title').innerText=n;onSnapshot(doc(db,"syndicates",n),(d)=>{if(d.exists())document.getElementById('syn-treasury').innerText=`VAULT: ${d.data().treasury} üíé`;});if(syndicateUnsub)syndicateUnsub();const q=query(collection(db,"syndicates",n,"tasks"));syndicateUnsub=onSnapshot(q,(s)=>{document.getElementById('col-todo').innerHTML="";document.getElementById('col-prog').innerHTML="";document.getElementById('col-done').innerHTML="";s.forEach(doc=>{const t=doc.data();const c=`<div class="task-card" draggable="true" ondragstart="drag(event,'${doc.id}')">${t.text}</div>`;document.getElementById(`col-${t.status}`).innerHTML+=c;});});}
        window.addTask=async()=>{const t=prompt("INTEL:");if(t)await addDoc(collection(db,"syndicates",userData.syndicate,"tasks"),{text:t,status:'todo'});}
        window.allowDrop=(ev)=>ev.preventDefault(); window.drag=(ev,id)=>ev.dataTransfer.setData("text",id); window.drop=async(ev,s)=>{ev.preventDefault();const id=ev.dataTransfer.getData("text");if(db)await updateDoc(doc(db,"syndicates",userData.syndicate,"tasks",id),{status:s});}

        if(auth) { onAuthStateChanged(auth, async (user) => { if(user) { currentUser=user; document.getElementById('auth-btn').innerText="LOGOUT"; document.getElementById('auth-btn').onclick=()=>signOut(auth); document.querySelectorAll('.hidden').forEach(el=>{if(el.id!=='holodeck-modal'&&!el.classList.contains('modal-overlay'))el.classList.remove('hidden');}); document.getElementById('shard-wallet').style.display='block'; onSnapshot(doc(db,"users",user.uid),(doc)=>{if(doc.exists()){userData=doc.data();updateIDCard();}else{setDoc(doc.ref,{email:user.email,rank:"INITIATE",avatar:"ü§ñ",shards:0});}}); } else { currentUser=null; document.getElementById('auth-btn').innerText="INITIALIZE"; document.getElementById('auth-btn').onclick=()=>openModal('login'); document.querySelectorAll('#chat-btn,#id-card-btn,#holodeck-btn,#syndicate-btn,#map-btn,#shard-wallet,#breach-btn').forEach(el=>el.classList.add('hidden')); } }); }
        function updateIDCard(){if(!currentUser)return;document.getElementById('id-email').innerText=currentUser.email.split('@')[0].toUpperCase();document.getElementById('id-rank').innerText=userData.rank;document.getElementById('id-avatar').innerText=userData.avatar;document.getElementById('shard-wallet').innerText="üíé "+(userData.shards||0);document.getElementById('qrcode').innerHTML="";new QRCode(document.getElementById("qrcode"),{text:currentUser.uid,width:60,height:60});}
        window.openIDCard=()=>{playClick();updateIDCard();document.getElementById('id-modal').classList.remove('hidden');}
        window.cheatCode=async()=>{cheatCount++;if(cheatCount===5){if(currentUser){await updateDoc(doc(db,"users",currentUser.uid),{shards:increment(1000)});alert("CHEAT: +1000 SHARDS");}cheatCount=0;}}
        window.scrollToArena=()=>document.getElementById('arena').scrollIntoView({behavior:'smooth'});
        window.startTrial=()=>{playClick();document.getElementById('chat-display').innerHTML+='<div class="msg ai">INITIALIZING...</div>';askGemini("Act as AI. Ask 1 robotics question.");}
        window.toggleMic=()=>{playClick();const S=window.SpeechRecognition||window.webkitSpeechRecognition;if(!S){alert("No Mic.");return;}const r=new S();r.lang='en-US';r.start();document.getElementById('mic-btn').innerText="LISTENING...";r.onresult=(e)=>{const t=e.results[0][0].transcript;document.getElementById('mic-btn').innerText="üé§";document.getElementById('chat-display').innerHTML+=`<div class="msg user">${t}</div>`;askGemini(`User:"${t}". If correct say Correct.`);}}
        
        // ANIM
        document.addEventListener('mousemove',(e)=>{const eye=document.querySelector('.core-eye-socket');const p=document.getElementById('eye-pupil');const r=eye.getBoundingClientRect();const x=r.left+r.width/2;const y=r.top+r.height/2;const a=Math.atan2(e.clientY-y,e.clientX-x);const d=Math.min(25,Math.hypot(e.clientX-x,e.clientY-y)/10);p.style.transform=`translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px)`;});
        const sc=new THREE.Scene();const cam=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);const ren=new THREE.WebGLRenderer({canvas:document.getElementById('bg-canvas'),alpha:true});ren.setSize(window.innerWidth,window.innerHeight);const geo=new THREE.BufferGeometry();const pos=new Float32Array(2400);for(let i=0;i<2400;i++)pos[i]=(Math.random()-0.5)*60;geo.setAttribute('position',new THREE.BufferAttribute(pos,3));const mat=new THREE.PointsMaterial({size:0.1,color:0x00f3ff});const mesh=new THREE.Points(geo,mat);sc.add(mesh);cam.position.z=15;function anim(){requestAnimationFrame(anim);mesh.rotation.y+=0.001;ren.render(sc,cam);}anim();
    </script>
</body>
</html>